<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">

<link rel="import" href="../elements/aptcopilot-header.html">
<link rel="import" href="../elements/aptcopilot-search.html">

<link rel="import" href="../bower_components/google-map/google-map.html">

<dom-module id="aptcopilot-properties">
    <template>
        <style>
            aptcopilot-search {
                --aptcopilot-search-width: 610px;
            }

            google-map {
                height: 750px;
                width: 100%;
                border: 1px solid #018ED0;
                margin-right: 10px;
            }

            .properties-content {
                display: flex;
                margin-top: 30px;
            }

            .properties-side-list {
                height: 750px;
                overflow: auto;
                width: 30%;
            }

            h1 {
                display: block;
                text-align: center;
                color: #464A56;

            }

            h3 {
                display: block;
                text-align: left;
                color: #464A56;

            }
        </style>

        <aptcopilot-search></aptcopilot-search>

        <div id="containerdiv">
            <div id="containerelm">
                <button class="containbtn" type="button" on-click="loadAllProperties">Show All Properties</button>
                <button class="containbtn" type="button" on-click="loadMarketRateProperties">Show Market Rate Properties</button>
                <button class="containbtn" type="button" on-click="loadAffordableProperties">Show Affordable Properties</button>
            </div>

            <div class="properties-content">
                <google-map fit-to-markers map={{map}} api-key="AIzaSyDwZt-Shm5g3q8oCNYX6vQ97jo81FIrij4" latitude="40.354528" longitude="-111.757338"
                    zoom="7" on-latitude-changed="mapChanged" on-longitude-changed="mapChanged"  on-google-map-ready="mapReady">
                    <template is="dom-repeat" items="[[mapFilteredProperites]]">
                        <google-map-marker latitude="[[item.lat]]" property="[[item]]" on-google-map-marker-click="click" longitude="[[item.lng]]"
                            icon="../images/mapdot.png">
                            <h1>
                                <a href='/views/property.html?id=[[item.id]]'>[[item.name]]</a>
                            </h1>
                            <h3> Units: [[item.units]]</h3>
                            <h3> Address: [[item.address]]</h3>
                            <h3> City: [[item.city]]</h3>
                            <h3> Type: [[item.type]]</h3>
                            <img src='../proppics/' + encodeURI([[item.mainpic]]) width='400' height='228' id='pic'>
                        </google-map-marker>
                    </template>
                </google-map>
                <div class="properties-side-list">
                    <template is="dom-repeat" items="[[mapFilteredProperites]]">
                        <h1>
                            <a href='/views/property.html?id=[[item.id]]'>[[item.name]]</a>
                        </h1>
                        <h3> Units: [[item.units]]</h3>
                        <h3> Address: [[item.address]]</h3>
                        <h3> City: [[item.city]]</h3>
                        <h3> Type: [[item.type]]</h3>
                        <img src='../proppics/[[item.mainpic]]' width='400' height='228' id='pic'>
                    </template>
                </div>
            </div>

    </template>

    <script>
        class AptcopilotProperties extends Polymer.Element {
            static get is() { return "aptcopilot-properties"; }

            static get properties() {
                return {
                    properties: {
                        type: Array,
                        value: []
                    },
                    mapFilteredProperites: {
                        type: Array,
                        value: []
                    },
                    map: {
                        type: Object
                    }
                }
            }

            mapReady(e) {
                this.loadAllProperties();
            }

            mapChanged(e) { 
                var lat = e.target.latitude
                var long = e.target.longitude

                if (this.map) {
                var bounds = this.map.getBounds();
                this.mapFilteredProperites = this.properties.filter(function(prop) {
                    return bounds.contains(new google.maps.LatLng(parseFloat(prop.lat), parseFloat(prop.lng)))
                })
            }
            }

            propertiesLoaded(that, data) {
                that.mapFilteredProperites = data;
                that.properties = data;
            }

            mapFilterProperties(that, f) {
                this.mapFilteredProperites = this.properties.filter(f);
            }

            _buildSideList(data) {
                console.log(data)
                var scrollView = this.shadowRoot.querySelector('.properties-side-list')
                scrollView.innerHTML = ""

                data.forEach(function (apt, i) {
                    var infowincontent = new MarkerInfo(apt.id, apt.name, apt.type,
                        apt.units, apt.address, apt.city,
                        apt.mainpic)

                    scrollView.appendChild(infowincontent)
                });
            }

            _makeRequest(url, callback) {
                var request = new XMLHttpRequest();
                request.open("GET", url, true);
                request.setRequestHeader("Accept", "application/json")
                request.setRequestHeader("x-pingpong", "pingpong")

                var that = this;
                request.onload = function (e) {
                    if (this.readyState === 4 && this.status === 200) {
                        callback(that, JSON.parse(this.responseText));
                    } else {
                        console.error(this.statusText);
                    }
                };

                request.onerror = function (e) {
                    console.error(this.statusText);
                }

                request.send();
            }

            loadAllProperties() {
                this._makeRequest(config.apibaseurl + '/properties', this.propertiesLoaded)
            }

            loadMarketRateProperties() {
                this._makeRequest(config.apibaseurl + '/properties?type=marketrate', this.propertiesLoaded)
            }

            loadAffordableProperties() {
                this._makeRequest(config.apibaseurl + '/properties?type=affordable', this.propertiesLoaded)
            }

        }
        customElements.define(AptcopilotProperties.is, AptcopilotProperties);
    </script>